---
import { GLOBAL } from "../lib/variables";
import Layout from "../layouts/Layout.astro";
import ArticleList from "../components/articles/ArticleList.astro";
import Section from "../components/common/Section.astro";
import type { Article } from "../lib/samples/articles";
import { API_ENDPOINTS } from "../lib/config";

// Fetch latest articles
const response = await fetch(API_ENDPOINTS.articles.latest, {
  method: 'GET',
  headers: {
    'Accept': 'application/json'
  }
});

let articles: Article[] = [];

if (response.ok) {
  const data = await response.json();
  articles = data.articles || [];
}
---

<Layout>
  <Fragment slot="head">
    <title>{GLOBAL.projectTitle}</title>
    <meta
      name="description"
      content={GLOBAL.projectLongDescription}
    />
  </Fragment>
  <Section>
    <div class="flex flex-col gap-8">
      <h1 class="text-3xl font-bold text-center">Latest Articles</h1>
      <ArticleList articles={articles} />
    </div>
  </Section>
</Layout>

<script define:vars={{ API_BASE_URL: import.meta.env.PUBLIC_API_BASE_URL || 'http://localhost:8080' }}>
  // Format date function
  function formatDate(dateString: string | undefined) {
    if (!dateString) {
      return 'No date available';
    }
    try {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    } catch (error) {
      return 'Invalid Date';
    }
  }

  // Define API endpoints for client-side use
  const API_ENDPOINTS = {
    articles: {
      latest: `${API_BASE_URL}/api/articles/latest`
    }
  };

  // Client-side fetch to update articles
  async function fetchArticles() {
    try {
      const response = await fetch(API_ENDPOINTS.articles.latest, {
        method: 'GET',
        headers: {
          'Accept': 'application/json'
        }
      });
      
      if (!response.ok) {
        throw new Error('Failed to fetch articles');
      }
      
      const { articles: apiArticles = [] } = await response.json();
      
      // Update the articles list in the UI
      const articleList = document.querySelector('.grid');
      if (articleList) {
        articleList.innerHTML = apiArticles.map((article) => `
          <article class="w-[600px] h-32 mx-auto bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="h-full flex flex-col items-center justify-center text-center">
              <h3 class="text-xl font-semibold line-clamp-2">
                <a 
                  href="${article.link}" 
                  target="_blank" 
                  rel="noopener noreferrer"
                  class="hover:text-blue-500 dark:hover:text-blue-400"
                >
                  ${article.title}
                </a>
              </h3>
              <p class="text-gray-600 dark:text-gray-400">
                ${formatDate(article.date)}
              </p>
            </div>
          </article>
        `).join('');
      }
    } catch (error) {
      console.error('Error fetching articles:', error);
      // Show error message in the UI
      const articleList = document.querySelector('.grid');
      if (articleList) {
        articleList.innerHTML = `
          <div class="text-center py-12">
            <p class="text-red-500">Failed to load articles. Please try again later.</p>
          </div>
        `;
      }
    }
  }

  // Fetch articles when the page loads
  document.addEventListener('DOMContentLoaded', fetchArticles);
</script>
