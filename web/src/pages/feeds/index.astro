---
import { GLOBAL } from "../../lib/variables";
import Layout from "../../layouts/Layout.astro";
import FeedList from "../../components/feeds/FeedList.astro";
import Section from "../../components/common/Section.astro";
import type { Feed } from "../../lib/samples/feeds";
import { API_ENDPOINTS } from "../../lib/config";

// Fetch feeds server-side
const response = await fetch(API_ENDPOINTS.feeds.list, {
  method: 'GET',
  headers: {
    'Accept': 'application/json'
  }
});

let feeds: Feed[] = [];

if (response.ok) {
  const data = await response.json();
  feeds = data.feeds || [];
}
---

<Layout>
  <Fragment slot="head">
    <title>{GLOBAL.username} â€¢ {GLOBAL.projectTitle}</title>
    <meta
      name="description"
      content={GLOBAL.projectLongDescription}
    />
  </Fragment>
  <Section>
    <FeedList feeds={feeds} />
  </Section>
</Layout>

<script define:vars={{ API_BASE_URL: import.meta.env.PUBLIC_API_BASE_URL || 'http://localhost:8080' }}>
  // Define API endpoints for client-side use
  const API_ENDPOINTS = {
    feeds: {
      list: `${API_BASE_URL}/api/feeds`
    }
  };

  async function fetchFeeds() {
    try {
      const response = await fetch(API_ENDPOINTS.feeds.list, {
        method: 'GET',
        headers: {
          'Accept': 'application/json'
        }
      });
      if (!response.ok) {
        throw new Error('Failed to fetch feeds');
      }
      const { feeds: apiFeeds = [] } = await response.json();
      
      // Update the feeds list in the UI
      const feedList = document.querySelector('.grid');
      if (feedList) {
        feedList.innerHTML = apiFeeds.map((feed) => `
          <div class="p-6 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-blue-500 dark:hover:border-blue-400 transition-colors">
            <div class="flex flex-col gap-2">
              <h3 class="text-xl font-semibold">
                <a href="${feed.link}" target="_blank" rel="noopener noreferrer" class="hover:text-blue-500 dark:hover:text-blue-400">
                  ${feed.name}
                </a>
              </h3>
              <a href="/feeds/${feed.id}" class="text-blue-500 hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-300">
                View articles
              </a>
            </div>
          </div>
        `).join('');
      }
    } catch (error) {
      console.error('Error fetching feeds:', error);
      // Show error message in the UI
      const feedList = document.querySelector('.grid');
      if (feedList) {
        feedList.innerHTML = `
          <div class="text-center py-12">
            <p class="text-red-500">Failed to load feeds. Please try again later.</p>
          </div>
        `;
      }
    }
  }

  // Fetch feeds when the page loads
  document.addEventListener('DOMContentLoaded', fetchFeeds);
</script> 